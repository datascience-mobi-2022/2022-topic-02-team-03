---
title: "tumor_vs_normal_gsea"
author: "Chloé"
date: "31/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load all recquired packages & data}
#if you haven't yet installed fgsea package, run the following code

#if (!require("BiocManager", quietly = TRUE))
 #   install.packages("BiocManager")
#BiocManager::install("fgsea")

#to install cinaR, first run
#if (!require("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")

#BiocManager::install("limma")
#if (!require("BiocManager", quietly = TRUE))
 #   install.packages("BiocManager")

#BiocManager::install("edgeR")

#install.packages("cinaR")

#to install enrichplot, first run
#if (!require("BiocManager", quietly = TRUE))
 #   install.packages("BiocManager")

#BiocManager::install("enrichplot")

library(limma)
library(edgeR)
library(cinaR)
library(fgsea)
library(ggplot2)
library(biomaRt)
library(enrichplot)

LUAD_tumor_vs_norm_clean <- readRDS("./data/LUAD_tumor_vs_norm_clean.RDS")
luad.info = LUAD_tumor_vs_norm_clean[["infomatrix"]]


rm(LUAD_tumor_vs_norm_clean)
```

## create a sorted list of p-values from fold change

```{r ranked p-values}

#create a sorted list of p-values from wilcoxon test (see also: data cleanup)
sorted_p = sort(luad.info$p.wilc, decreasing = F)
head(sorted_p)

#finalise ranked p-values dataframe
ranked.pvalues = data.frame(p.wilc = sorted_p)
rownames(ranked.pvalues) = make.names(rownames(luad.info))
head(ranked.pvalues)

rm(sorted_p)
```

## run GSEA

```{r change external_gene_name -> entrezgene_id}
#ensembl <- useEnsembl(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
#entrezgene_id <- getBM(mart = ensembl, values = rownames(luad.info), filters = "external_gene_name", attributes = c("entrezgene_id", "external_gene_name"))
#head(entrezgene_id)
#length(which(is.na(entrezgene_id)))
#length(entrezgene_id$entrezgene_id)
```

```{r prepare and run GSEA}
#load genesets
metabolism_list_gs = readRDS("./data/metabolism_list_gs.RDS")
genesets <- readRDS("./data/hallmarks_genesets.rds")

#stats argument (ranked p values) needs to be the right format
Names = rownames(ranked.pvalues)
Values = ranked.pvalues$p.wilc
names(Values) = Names

GSEA = fgsea(pathways = genesets$genesets, stats = Values)

rm(Names)

#View(GSEA)
```

Fehlermeldung beim obrigen Chunk: 81.35% der Liste sind ties

```{r Einschub: Überprüfung der Warnmeldung beim obrigen Chunk}
length(unique(ranked.pvalues$p.wilc)) #gibt die Anzahl der einzigartigen Werte in unserer Liste

#Berechnung des Anteils von einzigartigen p Values
length(unique(ranked.pvalues$p.wilc)) / length(ranked.pvalues$p.wilc) 
#18,65% der p values sind einzigartig

tail(sort(table(ranked.pvalues$p.wilc)),10) #gibt die 5 Werte die am meisten vorkommen und wie oft sie vorkommen
```

### Dot plot

```{r dot plot}
dotplot(object = GSEA, x = ,color = ranked.pvalues$p.wilc, size = count, title = "tumor vs normal GSEA results")
```

```{r}

order = GSEA[order(GSEA$size)]$pathway # sort pathways by size
ggplot(gsea.order[1:10,], aes(y=factor(pathway, level = order),
                       x = size,
                       col=padj,
                       size = NES)) + #y: is sorted by size
  geom_point()+
  labs(title = "dotplot", x ="GSEA: size", y = "pathways in LUAD")

```

```{r test dotplot...}
#(so stehts im beispiel): https://rdrr.io/bioc/enrichplot/man/dotplot.html

library(DOSE)
data(geneList)
de <- names(geneList)[1:100]
x <- enrichDO(de)
dotplot(x)
```

```{r unser dotplot...}
# wir wollen die "entrezgene_id`s" unsrer gene, damit enrichDO funktioniert
ensembl <- useEnsembl(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
entrezgene_id <- getBM(mart = ensembl, values = rownames(luad.info), filters = "external_gene_name", attributes = c("entrezgene_id", "external_gene_name"))


gene_ids = as.character(entrezgene_id$entrezgene_id)
View(gene_ids)
x <- enrichDO(gene_ids)
dotplot(x)

```

```{r gsea plot}
data(geneList)
x <- gseDO(geneList)
gseaplot(x, geneSetID=1)
```
